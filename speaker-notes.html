<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speaker Notes - From Code to Chords</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .notes-header {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .slide-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .slide-counter {
            font-size: 18px;
            font-weight: 600;
            color: #00ff87;
            background: rgba(0, 255, 135, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(0, 255, 135, 0.3);
        }
        
        .slide-title {
            font-size: 16px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff6b6b;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.connected {
            background: #00ff87;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .notes-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            line-height: 1.6;
        }
        
        .notes-content h3 {
            color: #00ff87;
            font-size: 20px;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(0, 255, 135, 0.3);
            padding-bottom: 8px;
        }
        
        .notes-content p {
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .notes-content strong {
            color: #60efff;
            font-weight: 600;
        }
        
        .notes-content .highlight {
            background: rgba(0, 255, 135, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            color: #00ff87;
        }
        
        .no-notes {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
            margin-top: 100px;
            font-size: 18px;
        }
        
        .loading {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 100px;
            font-size: 18px;
        }
        
        .timer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            color: #00ff87;
            border: 1px solid rgba(0, 255, 135, 0.3);
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .notes-header {
                padding: 10px 15px;
            }
            
            .slide-counter {
                font-size: 14px;
                padding: 6px 12px;
            }
            
            .slide-title {
                font-size: 14px;
            }
            
            .notes-content {
                padding: 20px;
            }
            
            .notes-content h3 {
                font-size: 18px;
            }
            
            .notes-content p {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="notes-header">
        <div class="slide-info">
            <div class="slide-counter">
                <span id="slide-counter">1 / 8</span>
            </div>
            <div class="slide-title" id="slide-title">From Code to Chords</div>
        </div>
        <div class="connection-status">
            <div class="status-indicator" id="connection-status"></div>
            <span id="connection-text">Connecting...</span>
        </div>
    </div>
    
    <div class="notes-content" id="notes-content">
        <div class="loading">Loading speaker notes...</div>
    </div>
    
    <div class="timer" id="timer">00:00</div>
    
    <script>
        class SpeakerNotesWindow {
            constructor() {
                this.currentSlide = 0;
                this.totalSlides = 8;
                this.presentationData = null;
                this.startTime = Date.now();
                this.timerInterval = null;
                this.isConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 10;
                
                this.init();
            }
            
            async init() {
                await this.loadPresentationData();
                this.setupEventListeners();
                this.startTimer();
                this.startConnectionMonitoring();
            }
            
            async loadPresentationData() {
                try {
                    const response = await fetch('./presentation-data.json');
                    if (!response.ok) {
                        throw new Error(`Failed to load presentation data: ${response.status}`);
                    }
                    this.presentationData = await response.json();
                    this.totalSlides = this.presentationData.slides.length;
                } catch (error) {
                    console.error('Error loading presentation data:', error);
                }
            }
            
            setupEventListeners() {
                // Listen for messages from the main presentation window
                window.addEventListener('message', (event) => {
                    if (event.origin !== window.location.origin) {
                        return; // Security check
                    }
                    
                    switch (event.data.type) {
                        case 'slide-changed':
                            this.updateSlide(event.data.detail);
                            break;
                        case 'presentation-exit':
                            this.handlePresentationExit();
                            break;
                        case 'presentation-ready':
                            this.handlePresentationReady();
                            break;
                    }
                });
                
                // Handle window close
                window.addEventListener('beforeunload', () => {
                    this.notifyMainWindow({ type: 'speaker-notes-closed' });
                });
                
                // Handle visibility change (for reconnection)
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        this.startConnectionMonitoring();
                    }
                });
            }
            
            startConnectionMonitoring() {
                // Try to establish connection with main window
                this.tryReconnect();
            }
            
            tryReconnect() {
                if (this.isConnected || this.reconnectAttempts >= this.maxReconnectAttempts) {
                    return;
                }
                
                this.reconnectAttempts++;
                
                // Try to ping the main window
                try {
                    if (window.opener && !window.opener.closed) {
                        window.opener.postMessage({ type: 'speaker-notes-ready' }, window.location.origin);
                        this.updateConnectionStatus(true);
                    } else {
                        this.updateConnectionStatus(false);
                        // Retry after a delay
                        setTimeout(() => this.tryReconnect(), 2000);
                    }
                } catch (error) {
                    this.updateConnectionStatus(false);
                    setTimeout(() => this.tryReconnect(), 2000);
                }
            }
            
            updateConnectionStatus(connected) {
                this.isConnected = connected;
                const statusIndicator = document.getElementById('connection-status');
                const connectionText = document.getElementById('connection-text');
                
                if (connected) {
                    statusIndicator.classList.add('connected');
                    connectionText.textContent = 'Connected';
                    this.reconnectAttempts = 0;
                } else {
                    statusIndicator.classList.remove('connected');
                    connectionText.textContent = 'Disconnected';
                }
            }
            
            updateSlide(slideData) {
                this.currentSlide = slideData.currentSlide || 0;
                const slideType = slideData.slideType;
                const title = slideData.title;
                
                // Update slide counter and title
                document.getElementById('slide-counter').textContent = 
                    `${this.currentSlide + 1} / ${this.totalSlides}`;
                document.getElementById('slide-title').textContent = title || 'Untitled Slide';
                
                // Update notes content
                this.updateNotesContent(slideType);
            }
            
            updateNotesContent(slideType) {
                const notesContent = document.getElementById('notes-content');
                
                if (!this.presentationData || !this.presentationData.slides) {
                    notesContent.innerHTML = '<div class="no-notes">Presentation data not loaded</div>';
                    return;
                }
                
                const slideData = this.presentationData.slides.find(slide => slide.id === slideType);
                
                if (!slideData || !slideData.speakerNotes) {
                    notesContent.innerHTML = '<div class="no-notes">No speaker notes available for this slide</div>';
                    return;
                }
                
                const notes = slideData.speakerNotes;
                let html = `<h3>Speaker Notes</h3>`;
                
                // Format the speaker notes
                if (notes.opening) {
                    html += `<p><strong>Opening Hook:</strong> ${notes.opening}</p>`;
                }
                
                if (notes.focus) {
                    html += `<p><strong>Focus:</strong> ${notes.focus}</p>`;
                }
                
                if (notes.keyPoints) {
                    html += `<p><strong>Key Points:</strong> ${notes.keyPoints}</p>`;
                }
                
                if (notes.keyPoint) {
                    html += `<p><strong>Key Point:</strong> ${notes.keyPoint}</p>`;
                }
                
                if (notes.emphasize) {
                    html += `<p><strong>Emphasize:</strong> ${notes.emphasize}</p>`;
                }
                
                if (notes.analogy) {
                    html += `<p><strong>Analogy:</strong> ${notes.analogy}</p>`;
                }
                
                if (notes.question) {
                    html += `<p><strong>Question:</strong> ${notes.question}</p>`;
                }
                
                if (notes.example) {
                    html += `<p><strong>Example:</strong> ${notes.example}</p>`;
                }
                
                if (notes.interaction) {
                    html += `<p><strong>Interaction:</strong> ${notes.interaction}</p>`;
                }
                
                if (notes.fallback) {
                    html += `<p><strong>Fallback:</strong> ${notes.fallback}</p>`;
                }
                
                if (notes.closing) {
                    html += `<p><strong>Closing:</strong> ${notes.closing}</p>`;
                }
                
                if (notes.futureVision) {
                    html += `<p><strong>Future Vision:</strong> ${notes.futureVision}</p>`;
                }
                
                if (notes.timing) {
                    html += `<p><strong>Timing:</strong> <span class="highlight">${notes.timing}</span></p>`;
                }
                
                if (notes.highlight) {
                    html += `<p><strong>Highlight:</strong> ${notes.highlight}</p>`;
                }
                
                notesContent.innerHTML = html;
            }
            
            startTimer() {
                this.timerInterval = setInterval(() => {
                    const elapsed = Date.now() - this.startTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    
                    const timer = document.getElementById('timer');
                    timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }
            
            handlePresentationReady() {
                this.updateConnectionStatus(true);
            }
            
            handlePresentationExit() {
                // Close this window when presentation exits
                setTimeout(() => {
                    window.close();
                }, 1000);
            }
            
            notifyMainWindow(message) {
                try {
                    if (window.opener && !window.opener.closed) {
                        window.opener.postMessage(message, window.location.origin);
                    }
                } catch (error) {
                    console.warn('Could not notify main window:', error);
                }
            }
        }
        
        // Initialize the speaker notes window
        const speakerNotes = new SpeakerNotesWindow();
        
        // Debug helpers
        window.speakerNotes = speakerNotes;
        console.log('🎵 Speaker Notes Window Loaded');
    </script>
</body>
</html>
